<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html manifest="/application.manifest">
<head>
  <title>Nothing Calendar</title>
  <link href='./stylesheets/main.css' rel='stylesheet' type='text/css' /> 
  <script src="./javascripts/jquery-1.4.2.min.js"></script>
  <script src="./javascripts/jquery.calendar-widget.js"></script>
  <!--fixes a broken json parser on some android phones -->
  <script>window.JSON = null;</script>
  <script src="./javascripts/json2.js"></script>
  <script src="./javascripts/lawnchair-0.6.1.min.js"></script>
  <script src="./javascripts/lawnchair-adapter-webkit-sqlite-0.6.1.js"></script>
  <!-- adaprter kills ios 3
  <script src="./javascripts/lawnchair-adapter-indexed-db-0.6.1.js"></script>
  -->
  <script src="./javascripts/query.js"></script>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <link rel="Icon" href="./images/favicon.ico">
  <link rel="apple-touch-icon" href="./images/icon.png"/>
  <link rel="apple-touch-icon-precomposed" href="./images/precomposed-icon.png"/>
  <link rel="apple-touch-startup-image" href="./images/startup.png">

</head>

<body>
  <div class="wrap">
  <div class="nav_info">
    <div class="title">NothingCalendar</div>
    <div class="subtitle">Tracks occurences of some event.</div>
    <div class="stats">
      <span class="stat">Current Steak: <span id="current-streak">0</span></span>
      <span class="stat">Longest Steak: <span id="longest-streak">0</span></span>
      <span class="stat">Total Marks: <span id="total-marks">0</span></span>
    </div>
  <div class="nav">
    <span><a href="#" id="prev-month">Previous</a></span>
    <span><a href="#" id="clear-all">Clear All</a></span>
    <span><a href="#" id="next-month">Next</a></span>
  </div>
  </div>
  
  <div id="calendar">
    <p>Please enable Javascript to view this calendar.</p>
  </div>
   
  <p>
    Inspired by <a href="http://calendaraboutnothing.com">Calendar
  About Nothing</a>, in fact sharing open source <a href="https://github.com/entp/seinfeld">code</a>.
  </p>
  </div>
  <script>
  //setup offline storage
  var marks_store = new Lawnchair({name:'marks', adaptor:'dom indexed-db webkit-sqlite window-name'}, function(marks) {});
  var mark_count = 0;
  var longest_streak = 0;
  
  $(function(){
    //display calendar
    $("#calendar").calendarWidget({});

    setTimeout(function() { window.scrollTo(0, 1) }, 1000);
    restore_marks();
  });

  var update_links = function() {
    $(".date-item").click( function(){
      if($(this).hasClass('xmarksthespot')) {
        $(this).toggleClass('xmarksthespot');
        marks_store.remove($(this).attr('id'), function() {});
        mark_count -= 1;
      } else {
        marks_store.save({key:$(this).attr('id'),val:true});
        $(this).toggleClass('xmarksthespot');
        mark_count += 1;
      }
      marks_store.save({key:'last_updated',val:new Date()});
      $("#total-marks").html(mark_count);
      streaks();
      sync();
      return false;
    });
  }

  var sync = function() {
    console.log("start sync");
    sync_data = [];
    marks_store.all(function(items) { sync_data = items });
    $.post("/marks/sync", sync_data, function (data) {
      console.log(data);
      //var pendingItems = $.parseJSON(localStorage["pendingItems"]);  
      //pendingItems.shift();  
      //localStorage["pendingItems"] = JSON.stringify(pendingItems);  
      //setTimeout(sendPending, 100);  
    });  
  }

  var restore_marks = function() {
    update_links();
    mark_count = 0;
    marks_store.all(function(items) {
      items.forEach(function(item) {
        mark_count += 1;
        if(item.key!="last_updated") {
          console.log('cached-mark: '+item.key);
          $("#"+item.key.replace(/ /g,'.')).addClass('xmarksthespot');
        } else {
          console.log('last updated: '+item.key+' : '+item.val);
        }
      });
    });
    $("#total-marks").html(mark_count);
    streaks();
  }

  var dateFormatted = function(d) {
    var curr_date  = zeroPad(d.getDate(),2);
    var curr_month = zeroPad(d.getMonth() + 1,2); //months are zero based
    var curr_year  = zeroPad(d.getFullYear(),2);
    return (curr_month + "-" + curr_date + "-" + curr_year);
  }

  var zeroPad = function (num,count) {
    var numZeropad = num + '';
    while(numZeropad.length < count) {
      numZeropad = "0" + numZeropad;
    }
    return numZeropad;
  }

  //todo refactor this
  var streaks = function() {
    longest_streak = 0;
    var streak_count = 0;
    var current_streak = [];
    var current_streak_count = 0;
    var today = new Date();
    var yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
  
    marks_store.where('record.val==true').asc('key', function(){
      this.each(function(record, index) {
        //console.log('current: '+record.key);
  
        if(current_streak.length==0) {
          //console.log('first: '+record.key);
          current_streak.push(record.key)
          streak_count = current_streak.length;
          if(streak_count > longest_streak) {
            longest_streak = streak_count;
          }

        } else if(current_streak.length>0) {
          console.log('more than one');
          var tomorrow = new Date();
          var parts = current_streak[current_streak.length-1].split('-');
          tomorrow.setFullYear(parts[2], parts[0]-1, parts[1]); // year, month (0-based), day
          tomorrow.setTime(tomorrow.getTime() + 86400000);
          //console.log('tomorrow: '+dateFormatted(tomorrow));
          //console.log('matching: '+record.key);
          if(dateFormatted(tomorrow)==record.key) {
            //console.log('hit single');
            current_streak.push(record.key);
            streak_count = current_streak.length;
            if(streak_count > longest_streak) {
              longest_streak = streak_count;
            }
          } else {
            //update current streak
            $.each(current_streak, function(index, value) { 
              //console.log('today:'+dateFormatted(today));
              //console.log('match:'+value);
              if(dateFormatted(today)==value) {
                current_streak_count = current_streak.length;
              }
            });

            current_streak = [];
            current_streak.push(record.key)
            if(dateFormatted(today)==record.key || dateFormatted(yesterday)==record.key) {
              current_streak_count = current_streak.length;
            }
          }
         
        }

      })
    });

    //update current streak, which didn't hit the next streak case
    $.each(current_streak, function(index, value) { 
      console.log('today:'+dateFormatted(today));
      console.log('match:'+value);
      if(dateFormatted(today)==value || dateFormatted(yesterday)==value) {
        current_streak_count = current_streak.length;
      }
    });

    $("#longest-streak").html(longest_streak);
    $("#current-streak").html(current_streak_count);
  }

  $('#next-month').click( function() {
    var next_month = month + 1;
    if(next_month >= 12) {
      year = year + 1;
      next_month = 0;
    }
    $("#calendar").calendarWidget({
        month: next_month,
	year: year
    });
    restore_marks();
    return false;
  });

  $('#prev-month').click( function() {
    var prev_month = month - 1;
    if(prev_month < 0) {
      year = year - 1;
      prev_month = 11;
    }
    $("#calendar").calendarWidget({
        month: prev_month,
	year: year
    });
    restore_marks();
    return false;
  });

  $('#clear-all').click( function() {
    marks_store.nuke();
    mark_count = 0;
    $("#calendar").calendarWidget({
        month: month,
	year: year
    });
    restore_marks();
    return false;
  });

  </script>
</body>
</html>